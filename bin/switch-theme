#!/bin/bash

RESTART=true
while getopts ":ct:" opt; do
  case ${opt} in
    c )
      RESTART=false
      ;;
    t )
      THEME_NAME=$OPTARG
      ;;
    \? )
      echo "ERROR: invalid option -$OPTARG" 1>&2
      exit 1
      ;;
    : )
      echo "ERROR: option -$OPTARG requires an argument" 1>&2
      exit 1
      ;;
  esac
done
if [ -z "$THEME_NAME" ]; then
  echo "ERROR: option -t is mandatory" 1>&2
  exit 1
fi
shift $((OPTIND -1))

echo "Switch current theme to $THEME_NAME"

THEME_FILE=~/.dotfiles/theme/$THEME_NAME
if ! [ -f $THEME_FILE ]; then
  echo "ERROR: desktop theme $THEME_NAME not found" >&2
  exit 1
fi

THEME_ST_PATCH=~/.dotfiles/st/st-$THEME_NAME-theme-0.8.2.diff
if ! [ -f $THEME_ST_PATCH ]; then
  echo "ERROR: suckless terminal theme $THEME_NAME not found" >&2
  exit 1
fi

source $THEME_FILE
cat ~/.dotfiles/i3/config | perl -pe 's/@@([^@]+)@@/$ENV{$1}/' > ~/.i3/config
cat ~/.dotfiles/xsession | perl -pe 's/@@([^@]+)@@/$ENV{$1}/' > ~/.xsession

# TODO: duplicated from install-or-update.sh
cd ~/.dotfiles/.dependencies/st
rm -rf st-0.8.2
tar -xzf st-0.8.2.tar.gz
cd st-0.8.2
patch < ~/.dotfiles/st/st-clipboard-0.8.2.diff
patch < ~/.dotfiles/st/st-scrollback-0.8.2.diff
patch < ~/.dotfiles/st/st-pragmata-0.8.2.diff
patch < $THEME_ST_PATCH
sudo make clean install

if $RESTART; then
  sudo systemctl restart display-manager
fi
